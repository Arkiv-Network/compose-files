volumes:
    op_geth_data:
    op_node_data:
    jwt_shared:
services:
    # ========================================
    # OPTIMISM NODE SERVICES
    # ========================================
    op-init:
        image: alpine:latest
        command:
            - sh
            - -c
            - |
              set -e

              # Create config directory
              mkdir -p /config

              # Generate JWT secret if it doesn't exist
              if [ ! -f '/jwt/jwt' ]; then
                echo 'Generating JWT secret'
                mkdir -p /jwt
                # Generate a 32-byte random hex string for JWT secret
                apk add --no-cache openssl
                openssl rand -hex 32 > /jwt/jwt
                chmod 666 /jwt/jwt
                echo 'JWT secret generated successfully'
              else
                echo 'JWT secret already exists, skipping generation'
              fi
        volumes:
            - op_node_data:/op-node
            - jwt_shared:/jwt
    op-geth-init:
        image: golemnetwork/golembase-l3-op-geth:v1.101511.0-1.2-holesky-test8-396300bb
        depends_on:
            op-init:
                condition: service_completed_successfully
        entrypoint: []
        command:
            - /bin/sh
            - -c
            - |
              set -e
              if [ ! -f '/geth/geth' ]; then
                echo 'Initializing geth data directory with genesis block...'

                # Use genesis file from op-init
                if ! geth init --state.scheme=hash --datadir='/geth' '/genesis.json'; then
                  echo 'ERROR: Failed to initialize geth with genesis block'
                  exit 1
                fi
                echo 'Geth initialized successfully with genesis block'
              else
                echo 'Geth data directory already initialized, skipping initialization'
              fi
        volumes:
            - op_geth_data:/geth
    op-geth:
        image: golemnetwork/golembase-l3-op-geth:v1.101511.0-1.2-holesky-test8-396300bb
        restart: unless-stopped
        stop_grace_period: 5m
        depends_on:
            op-geth-init:
                condition: service_completed_successfully
        command:
            - --networkid=60138453017
            - --datadir=/geth
            - --http
            - --http.corsdomain=*
            - --http.vhosts=*
            - --http.addr=0.0.0.0
            - --http.port=8545
            - --http.api=admin,debug,eth,txpool,net,engine,web3,golembase,txpool
            - --ws
            - --ws.addr=0.0.0.0
            - --ws.port=8546
            - --ws.origins=*
            - --ws.api=admin,debug,eth,txpool,net,engine,web3,golembase,txpool
            - --syncmode=snap
            - --authrpc.vhosts=*
            - --authrpc.addr=0.0.0.0
            - --authrpc.port=8551
            - --authrpc.jwtsecret=/jwt/jwt
            - --usb=false
            - --state.scheme=hash
            - --nat=none
            - --bootnodes=enode://d1e7418782c8d237ae7f986cdf7e6d551ed7449fbdeca4c091311ebb088bb742033ca77a92417da9f473cd22d3316d7e4d33b65102debc77158d34ae2e2d289c@37.27.230.18:46012,enode://acfe118b19f602d7e50d6e6a09695132fba43815ec258ad6695b31bc7873e7c62b499dccb39eaabf0c3d8edff4ee90e8132b596b3a720a7f242f4b5e3e451389@5.9.17.176:46014,enode://3e45284567092a3b19e8a7d0fe52ca11c440fc7ac433186ae3b43a1091fdbc844e939b51c4c571bc56930218c9cf1a5136d4ea403feb8597d42aa2de99825830@78.46.85.197:46016,enode://8e702c144dccb67692de2558ecadf5242ee110316e4300e1480c28b9969da6a466c2bb2b70f8f816e1207d837c5189155868c04115ca591b9fd225d286f14769@144.76.174.235:46018,enode://e0a69a1244ca52a0b4c975dd24f2422154f903175d155de1536b7d4d48cb10ef9357e80e2aef3dc5dbba53a26b98b5529253b0476f96ceced8c3b28a728709d7@78.46.85.197:46020
            - --txpool.disable.non.golembase.transactions=true
        ports:
            - 8545:8545
            - 8546:8546
        volumes:
            - op_geth_data:/geth
            - jwt_shared:/jwt
    op-node:
        image: golemnetwork/golembase-l3-op-node:v1.13.4-holesky-test8-cefa0325
        restart: unless-stopped
        stop_grace_period: 5m
        depends_on:
            op-init:
                condition: service_completed_successfully
            op-geth:
                condition: service_started
        command:
            - op-node
            - --l1=https://rpc.l2.holesky.golem-base.io
            - --l1.beacon.ignore=true
            - --l1.rpckind=standard
            - --l1.trustrpc
            - --l2=http://op-geth:8551
            - --l2.enginekind=geth
            - --l2.jwt-secret=/jwt/jwt
            - --rpc.addr=0.0.0.0
            - --rpc.port=9545
            - --p2p.nat=true
            - --p2p.ban.peers=false
            - --p2p.bootnodes=enr:-KG4QF8O0QZvZREIAJJKcxjao8qaSdaDmPoUmsLTg4tbaelBAIOBuKA3svdl23IoyhAyShNmE95rI2PMt3HAjQEeGjaGAZiLceNQgmlkgnY0gmlwhCUb5hKHb3BzdGFja4eZ8J-E4AEAiXNlY3AyNTZrMaEDe1AgYXuidbGYn3SoDM0awq652yerKU2jsdANvKSYlaGDdGNwgrO9g3VkcIKzvQ,enr:-KG4QNQCNIM_XJ-pKEW7ivSe-VbJQWQYJqk9WC9C1lIbLjQmTrZyxH7lV7HNQTD8oI6SNznjXb1pRrXghTUhwbQA23CGAZiLcf55gmlkgnY0gmlwhAUJEbCHb3BzdGFja4eZ8J-E4AEAiXNlY3AyNTZrMaECTAaMcsKZURzkv-2S8rthRmQNImsCjTortA3DaQphbeODdGNwgrO_g3VkcIKzvw,enr:-KG4QPCvGs96KO1ehuun8uXwmaxbDfRxP_qwzx9rmoSBs9ARGflW1nlmNe2RlX6E_WbWw_BC5eoYwJshycQRnrrXFvqGAZiLcd4xgmlkgnY0gmlwhE4uVcWHb3BzdGFja4eZ8J-E4AEAiXNlY3AyNTZrMaED-W2pS0vJGBt75hcR0purk7gK-BWE1GdNSQs5JokcpnqDdGNwgrPBg3VkcIKzwQ,enr:-KG4QPV6r4YVZTeW-h7vYDzprVnoUrZaq2CZz3y3VPt2LWUrbDsWK78L7CMWQAZTniEit64U1kWF0hg5ub0O-cQTjLWGAZiLcemKgmlkgnY0gmlwhJBMruuHb3BzdGFja4eZ8J-E4AEAiXNlY3AyNTZrMaECxmQzOWPQq5t85eNxe3G3lbdN0qTRqFG4rOs0l6f9oP2DdGNwgrPDg3VkcIKzww,enr:-KG4QLRfdm9NdKc1oCBdnk-RcF4oqhIyguV5UbdNcKeZhDXfWJBKVf8NNlC17LolDN3Uz2OJMko5EuxGU-8Gs0JImY2GAZiLco_0gmlkgnY0gmlwhE4uVcWHb3BzdGFja4eZ8J-E4AEAiXNlY3AyNTZrMaECJkxfDpn6dwKg-mxn0IW2eyZBOi3JCpy-QfXJD8AIXw6DdGNwgrPFg3VkcIKzxQ
            - --p2p.listen.tcp=9222
            - --p2p.listen.udp=9222
            - --metrics.enabled
            - --metrics.addr=0.0.0.0
            - --metrics.port=7300
            - --syncmode=execution-layer
            - --rollup.config=/rollup.json
            - --log.level=info
        ports:
            - 9545:9545
        volumes:
            - jwt_shared:/jwt
            - op_node_data:/op-node
