volumes:
  op_geth_data: {}
  op_node_data: {}
  jwt_shared: {}
services:
  op-init:
    image: alpine:latest
    command:
    - sh
    - -c
    - |
      set -e

      # Create config directory
      mkdir -p /config

      # Generate JWT secret if it doesn't exist
      if [ ! -f '/jwt/jwt' ]; then
        echo 'Generating JWT secret'
        mkdir -p /jwt
        # Generate a 32-byte random hex string for JWT secret
        apk add --no-cache openssl
        openssl rand -hex 32 > /jwt/jwt
        chmod 666 /jwt/jwt
        echo 'JWT secret generated successfully'
      else
        echo 'JWT secret already exists, skipping generation'
      fi
    volumes:
    - op_node_data:/op-node
    - jwt_shared:/jwt
  op-geth-init:
    image: golemnetwork/golembase-l3-op-geth:v1.101511.0-0.2-holesky-n3-4bdf68d5
    depends_on:
      op-init:
        condition: service_completed_successfully
    entrypoint: []
    command:
    - /bin/sh
    - -c
    - |
      set -e
      if [ ! -f '/geth/geth' ]; then
        echo 'Initializing geth data directory with genesis block...'

        # Use genesis file from op-init
        if ! geth init --state.scheme=hash --datadir='/geth' '/genesis.json'; then
          echo 'ERROR: Failed to initialize geth with genesis block'
          exit 1
        fi
        echo 'Geth initialized successfully with genesis block'
      else
        echo 'Geth data directory already initialized, skipping initialization'
      fi
    volumes:
    - op_geth_data:/geth
  op-geth:
    image: golemnetwork/golembase-l3-op-geth:v1.101511.0-0.2-holesky-n3-4bdf68d5
    restart: unless-stopped
    stop_grace_period: 5m
    depends_on:
      op-geth-init:
        condition: service_completed_successfully
    command:
    - --networkid=13
    - --datadir=/geth
    - --http
    - --http.corsdomain=*
    - --http.vhosts=*
    - --http.addr=0.0.0.0
    - --http.port=8545
    - --http.api=admin,debug,eth,txpool,net,engine,web3,golembase,txpool
    - --ws
    - --ws.addr=0.0.0.0
    - --ws.port=8546
    - --ws.origins=*
    - --ws.api=admin,debug,eth,txpool,net,engine,web3,golembase,txpool
    - --syncmode=snap
    - --authrpc.vhosts=*
    - --authrpc.addr=0.0.0.0
    - --authrpc.port=8551
    - --authrpc.jwtsecret=/jwt/jwt
    - --usb=false
    - --state.scheme=hash
    - --nat=none
    - --bootnodes=enode://968bdbf119b5556cf1aa2f0a59c86822f317e277de26f8efab52fc34d0036e73640d60ad757197a914101c22c042d6ea2f702d51e9654f61858108be3224c1ce@195.201.165.105:30012,enode://5a46dcf077abc8f7684121e682e9913902faf199fa5b2a7fbce5af99dcfa9fabd73e7721fac5be96d8083a6bae8c79963c9a758636047f39ffa31c0e2ff3f35d@195.201.165.105:30014,enode://af6fd7373e838d6bb51c8923b5f9e78983636533836ce1dee8fbed30ccb710858499d8c8227ecfe244189efa223da175c7c6732e0a31928c6f3e43aa0143543f@195.201.165.105:30016,enode://105b53c5ec2db7708fcff1ed28d1797c949c4c6b5ba3bce5f80f83609f88ec51df9e03d10745a70f6301aa5bb4d9e58bd069c5ccd26cc220491673fe835b89c5@195.201.165.105:30018,enode://2d3b2f7721906ea036f08e946bbc1621e3106e2be33d48ad926e0bb125ba72e24be7cf157981d8833544306c30b7fcdefd17b67b32bfa3e30f630bf112fbbe84@195.201.165.105:30020
    - --txpool.disable.non.golembase.transactions=true
    ports:
    - 8545:8545
    - 8546:8546
    volumes:
    - op_geth_data:/geth
    - jwt_shared:/jwt
  op-node:
    image: golemnetwork/golembase-l3-op-node:v1.13.4-holesky-n3-f89c222d
    restart: unless-stopped
    stop_grace_period: 5m
    depends_on:
      op-init:
        condition: service_completed_successfully
      op-geth:
        condition: service_started
    command:
    - op-node
    - --l1=https://l2.holesky.golem-base.io/rpc
    - --l1.beacon.ignore=true
    - --l1.rpckind=standard
    - --l1.trustrpc
    - --l2=http://op-geth:8551
    - --l2.enginekind=geth
    - --l2.jwt-secret=/jwt/jwt
    - --rpc.addr=0.0.0.0
    - --rpc.port=9545
    - --p2p.nat=true
    - --p2p.ban.peers=false
    - --p2p.bootnodes=enr:-Jy4QKoxurAmXCsj4y4h_QXAac8QYKPEy_FaA1VDH2QmQ2QUSfLAOTogucyPd0RY-3e4NflGeu1TrOFX6re1uKq3aL-GAZldBj8OgmlkgnY0gmlwhMPJpWmHb3BzdGFja4INAIlzZWNwMjU2azGhAlpynf32yOxbp6UvUdMEdjdGFkNJ1jFd3k3jrJwDtizbg3RjcIJ1PYN1ZHCCdT0,enr:-Jy4QOG2kqJ3ugDx17oy_Mu5NspDVqheW7OoqBGrAPelG-qYTDqmZgnjCfdUPGclCxWLTIn-6ysiyjBlOh6Io8sCfB-GAZldBj_XgmlkgnY0gmlwhMPJpWmHb3BzdGFja4INAIlzZWNwMjU2azGhAv4fAeciwc1l-p5shiaCMj_ly6uOfwUUVGo8pGS6qDV5g3RjcIJ1P4N1ZHCCdT8,enr:-Jy4QLU10x4uy_kCIHZjloYsKfUqSu7tYQz25KtSPLY_KHXEOoqUon531kW5fkfLKzja_GPOe_TXQ2YRckuhwFC-HE6GAZldBj8rgmlkgnY0gmlwhMPJpWmHb3BzdGFja4INAIlzZWNwMjU2azGhAh3T4JMhncxYRtlteiFARAleHhi2ckBl80nJRpBiMRAng3RjcIJ1QYN1ZHCCdUE,enr:-Jy4QJNt6JoUkBX1h28f0QO4EtJvYrVBkVnisO_UbGTbWc3PI-EZibEuNdojXLht9ATx-dzxH54mEfjBZc3fhDBMR0mGAZldBj8AgmlkgnY0gmlwhMPJpWmHb3BzdGFja4INAIlzZWNwMjU2azGhAoVDUuv7HQ3rrn9-KgmDx4vj5FOrz50V9UCp_c6fCoA0g3RjcIJ1Q4N1ZHCCdUM,enr:-Jy4QFH1e1T13h-ijviMcAwT-RCnfFz_upI_AAXOmE4B8BrtM8g_nG15ZIPDusSMtm5uDmGU_qwl3_fMjsuvjWkX9IWGAZldBj8rgmlkgnY0gmlwhMPJpWmHb3BzdGFja4INAIlzZWNwMjU2azGhAqBWmbixWh-BrdGWNyEoNRlhRt-tgC4Gl-JoByxh4jiAg3RjcIJ1RYN1ZHCCdUU
    - --p2p.listen.tcp=9222
    - --p2p.listen.udp=9222
    - --metrics.enabled
    - --metrics.addr=0.0.0.0
    - --metrics.port=7300
    - --syncmode=execution-layer
    - --rollup.config=/rollup.json
    - --log.level=info
    ports:
    - 9545:9545
    volumes:
    - jwt_shared:/jwt
    - op_node_data:/op-node
