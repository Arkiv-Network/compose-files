volumes:
  op_geth_data: {}
  op_node_data: {}
  jwt_shared: {}
services:
  op-init:
    image: alpine:latest
    command:
    - /bin/sh
    - -c
    - |
      set -euo pipefail

      # Create config directory
      mkdir -p /config

      # Generate JWT secret if it doesn't exist
      if [ ! -f '/jwt/jwt' ]; then
        echo 'Generating JWT secret'
        mkdir -p /jwt
        # Generate a 32-byte random hex string for JWT secret
        apk add --no-cache openssl
        openssl rand -hex 32 > /jwt/jwt
        chmod 666 /jwt/jwt
        echo 'JWT secret generated successfully'
      else
        echo 'JWT secret already exists, skipping generation'
      fi
    volumes:
    - op_node_data:/op-node
    - jwt_shared:/jwt
  op-geth-init:
    image: golemnetwork/golembase-l3-op-geth:v1.101605.0-1.2-hoodi-asy-gw2-68f33d7e
    depends_on:
      op-init:
        condition: service_completed_successfully
    entrypoint: []
    command:
    - /bin/sh
    - -c
    - |
      set -euo pipefail

      if [ ! -f '/geth/geth' ]; then
        echo 'Initializing geth data directory with genesis block...'

        # Use genesis file from op-init
        if ! geth init --state.scheme=hash --datadir='/geth' '/genesis.json'; then
          echo 'ERROR: Failed to initialize geth with genesis block'
          exit 1
        fi
        echo 'Geth initialized successfully with genesis block'
      else
        echo 'Geth data directory already initialized, skipping initialization'
      fi
    volumes:
    - op_geth_data:/geth
  op-geth:
    image: golemnetwork/golembase-l3-op-geth:v1.101605.0-1.2-hoodi-asy-gw2-68f33d7e
    restart: unless-stopped
    stop_grace_period: 5m
    depends_on:
      op-geth-init:
        condition: service_completed_successfully
    command:
    - --networkid=13
    - --datadir=/geth
    - --http
    - --http.corsdomain=*
    - --http.vhosts=*
    - --http.addr=0.0.0.0
    - --http.port=8545
    - --http.api=admin,debug,eth,txpool,net,engine,web3,golembase,txpool
    - --ws
    - --ws.addr=0.0.0.0
    - --ws.port=8546
    - --ws.origins=*
    - --ws.api=admin,debug,eth,txpool,net,engine,web3,golembase,txpool
    - --syncmode=snap
    - --authrpc.vhosts=*
    - --authrpc.addr=0.0.0.0
    - --authrpc.port=8551
    - --authrpc.jwtsecret=/jwt/jwt
    - --usb=false
    - --state.scheme=hash
    - --nat=none
    - --bootnodes=enode://e800a63fcb306d8e7e3a0ad870310cc9ec077b1cace8b23a8f3a8bc4a6b4984e2a943454c94978279ef77c80e4b652d8ef43c394431f7712277a47482b6c9669@91.99.184.248:30060,enode://33e8733de99b0ae0d22ad6560741b2aaf00154f6b54a478c8e1a90fcfb8cc60724c8fa5dcd4647c72d0bbea6dc9b86cd7ebbdfdba75a1c3b0ed8ad3c577a3c52@49.13.30.29:30062,enode://796d685db4f5a31515c4cd20645d5b8cbcf650604f0ab56b362227693c6f2a63909f66bc0d2f6c11cb4d1a0586f5e634b151ce59da88972cbcd50c0bb21987a2@195.201.165.105:30064,enode://02df353288951a3b411b39fbd9b467654cd346ebf25b13517bf25fa6c60eb95720afabdab66b9c68a56fdc2dd3efa1c2d0697bd9ba2feefc8284847a120c82a2@91.99.94.10:30066,enode://203b859f7162cdba2fcc4ede2848a6873b9cc30bd8044ec72800e016228c09f69337a4f1eed87ede25f1eeb816c2635a653aa3e39c08180a21c7bd3600376b17@91.99.157.203:30068
    - --txpool.disable.non.golembase.transactions=true
    ports:
    - 8545:8545
    - 8546:8546
    volumes:
    - op_geth_data:/geth
    - jwt_shared:/jwt
  op-node:
    image: golemnetwork/golembase-l3-op-node:v1.16.2-hoodi-asy-gw2-83bc3020
    restart: unless-stopped
    stop_grace_period: 5m
    depends_on:
      op-init:
        condition: service_completed_successfully
      op-geth:
        condition: service_started
    command:
    - op-node
    - --altda.enabled=true
    - --altda.da-server=http://altai:3100
    - --altda.da-service=true
    - --l1=https://l2.hoodi.arkiv.network/rpc
    - --l1.beacon.ignore=true
    - --l1.rpckind=standard
    - --l1.trustrpc
    - --l2=http://op-geth:8551
    - --l2.enginekind=geth
    - --l2.jwt-secret=/jwt/jwt
    - --rpc.addr=0.0.0.0
    - --rpc.port=9545
    - --p2p.nat=true
    - --p2p.ban.peers=false
    - --p2p.bootnodes=enr:-Jy4QKPDxcvpwxHR5pRfCQHxW-Vz_SMcYq0CCyz2Zx_4RCdtOHt_cYzUFdewM1nOeITuONvzXhxsjOW86ReualGyDSeGAZxj9h2ggmlkgnY0gmlwhFtjuPiHb3BzdGFja4INAIlzZWNwMjU2azGhA2J-fQBo0-TmEvxyatE-wL6-g1c--SlRLTkgAs1yaRJ4g3RjcIJ1bYN1ZHCCdW0,enr:-Jy4QNkXpo94boJH1yz8rW251wEfd0u3qKfhVNi4xnp4TkWAKH9qJ0KCFm0wkgKaoJapmnD2xMYrymiXBpZPyh8e9dKGAZxj9hPkgmlkgnY0gmlwhDENHh2Hb3BzdGFja4INAIlzZWNwMjU2azGhApRBjLtMfh9eGLTOaK_wq62HVkMSYUlWmhLQI4-D27jxg3RjcIJ1b4N1ZHCCdW8,enr:-Jy4QNuE44mScpQVgAuTklL_j9wfP20bzZcWupAOh587K3FgAJ5Nk9qdtVXcd7Dx__RfnWh3oME2Pwi568cTYAe4cwuGAZxj9hf2gmlkgnY0gmlwhMPJpWmHb3BzdGFja4INAIlzZWNwMjU2azGhA3p6CYyI0T74STH-rbv_C-8kL3iSLgpuELIJ0gu0tDvlg3RjcIJ1cYN1ZHCCdXE,enr:-Jy4QM6F5Z0ckZLR2g67p1ZYhNN6EpvPDn_NI4-AumMTI_98T1os9XIN4m69-5ioZ4qXA7Ol9Op1pMH1xKKOHgWYdcSGAZxj9hFJgmlkgnY0gmlwhFtjXgqHb3BzdGFja4INAIlzZWNwMjU2azGhA0PwyiXltSj4RMowSgg1wKTAUEBUubJrmB4VtZJ8zhyqg3RjcIJ1c4N1ZHCCdXM,enr:-Jy4QIO5E-Ova-Ln5LLpIY-gIIKGh-zfNs7eQbd9mNdI2bTDaeayg0ZkmtDcVVvPHmEfNmD9mqLvVH56A2x8-zxtvnWGAZxj9hsGgmlkgnY0gmlwhFtjncuHb3BzdGFja4INAIlzZWNwMjU2azGhAmIYoBA9_5tz9AfwOT9jCEzC5Xc0W0aLwiSlLYEC4nvKg3RjcIJ1dYN1ZHCCdXU
    - --p2p.listen.tcp=9222
    - --p2p.listen.udp=9222
    - --metrics.enabled
    - --metrics.addr=0.0.0.0
    - --metrics.port=7300
    - --syncmode=execution-layer
    - --rollup.config=/rollup.json
    - --rollup.l1-chain-config=/genesis.json
    - --log.level=info
    ports:
    - 9545:9545
    volumes:
    - jwt_shared:/jwt
    - op_node_data:/op-node
  altai:
    image: golemnetwork/altai:latest
    restart: unless-stopped
    ports:
    - 3100:3100
    command:
    - --addr=0.0.0.0
    - --port=3100
    - --backends=http
    - --http.endpoint=https://altda-staging.gobas.me
    - --network=asy-gw2
    - --log.level=info
